<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en">
<head>
<link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-light.min.css" />
<link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-light.min.css" />
</head>
<body><div>
<h1>容器 CPU 配额限制</h1><h2>申请 CPU -&gt; 最大CPU</h2><p><kbd>round(exp(-3.1*x)*4*x+x, 1)</kbd>
</p>
<ul><li>x: 申请CPU</li>
<li>round: 四舍五入</li>
</ul>

<pre><code class="python"><span style="color: #989848;">import</span> math
<span style="color: #989848;">def</span> <span style="color: #424242; font-weight: bold;">compute_cpu</span>(x):
    <span style="color: #989848;">return</span> <span style="color: #424242; font-weight: bold;">round</span>(x+math.exp(-3.1*x)*4*x,1)

<span style="color: #4fa8a8;">r</span> = [(<span style="color: #b85c57;">"request"</span>, <span style="color: #b85c57;">"max"</span>)]
<span style="color: #989848;">for</span> i <span style="color: #989848;">in</span> [0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2.0,2.5,2.9]:
     r.append((i , compute_cpu(i)))
<span style="color: #989848;">return</span> r
</code></pre>

<h2>以下脚本用于查询某个节点容器的 CPU shares，period，quota 值</h2><pre><code class="bash"><span style="color: #40883f;"># </span><span style="color: #40883f;">cpu_stat.sh</span>
<span style="color: #424242; font-weight: bold;">get_container_id</span>() {
    <span style="color: #424242; font-weight: bold;">echo</span> $<span style="color: #4fa8a8;">1</span> | awk <span style="color: #b85c57;">'{split($0, a, "/"); print a[7]}'</span>
}
<span style="color: #989848;">for</span> dir<span style="color: #989848;"> in</span> $(ls -d /sys/fs/cgroup/cpu,cpuacct/docker/*/); <span style="color: #989848;">do</span>
    <span style="color: #4fa8a8;">share</span>=$(cat $(printf <span style="color: #b85c57;">"%scpu.shares"</span> $<span style="color: #4fa8a8;">dir</span>))
    <span style="color: #4fa8a8;">period</span>=$(cat $(printf <span style="color: #b85c57;">"%scpu.cfs_period_us"</span> $<span style="color: #4fa8a8;">dir</span>))
    <span style="color: #4fa8a8;">quota</span>=$(cat $(printf <span style="color: #b85c57;">"%scpu.cfs_quota_us"</span> $<span style="color: #4fa8a8;">dir</span>))
    <span style="color: #424242; font-weight: bold;">echo</span> $(get_container_id $<span style="color: #4fa8a8;">dir</span>) $<span style="color: #4fa8a8;">share</span> $<span style="color: #4fa8a8;">period</span> $<span style="color: #4fa8a8;">quota</span>
<span style="color: #989848;">done</span>
</code></pre>
</div></body>
</html>
